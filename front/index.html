<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Тест</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
</head>
<body>
<div id="root">
    <h1>Ща всё будет</h1>
</div>
<!-- Create category -->
<div class="modal fade" id="createExpenseCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="ajaxForm" action="/expense-category" method="POST">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Создание категории</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Название категории</label>
                        <input name="title" class="form-control" placeholder="Корм кошке">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <select name="type" class="form-control">
                            <option value="1">Регулярный обязательный расход</option>
                            <option value="2">Накопление</option>
                            <option value="3">Дополнительный расход</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Создать</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Update category -->
<div class="modal fade" id="updateExpenseCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="ajaxForm" data-action-template="/expense-category/{:id}" action="" method="PUT">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Изменение категории</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Название категории</label>
                        <input name="title" class="form-control" placeholder="Корм кошке">
                        <input type="hidden" name="id">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <select name="type" class="form-control">
                            <option value="1">Регулярный обязательный расход</option>
                            <option value="2">Накопление</option>
                            <option value="3">Дополнительный расход</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-warning">Изменить</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Delete category -->
<div class="modal fade" id="deleteExpenseCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="ajaxForm" data-action-template="/expense-category/{:id}" action="" method="DELETE">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Вы уверены, что хотите удалить категорию?</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Create income -->
<div class="modal fade" id="createIncomeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="ajaxForm" action="/income" method="POST">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Создание дохода</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input name="title" class="form-control" placeholder="Зарплата">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Сумма</label>
                        <input name="amount" class="form-control" placeholder="0.0">
                        <input type="hidden" name="currency" value="RUB">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Дата</label>
                        <input name="date" class="form-control" placeholder="ДД.ММ.ГГГГ">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Создать</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Delete income -->
<div class="modal fade" id="deleteIncomeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="ajaxForm" data-action-template="/income/{:id}" action="" method="DELETE">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Вы уверены, что хотите удалить доход?</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Create planned expense -->
<div class="modal fade" id="createPlannedExpense" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="ajaxForm" action="/planned-expense" method="POST">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Создание планируемого расхода</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Сумма</label>
                        <input name="amount" class="form-control" placeholder="0.0">
                        <input type="hidden" name="currency" value="RUB">
                        <input type="hidden" name="categoryId">
                    </div>
                    <div class="mb-3 date-input" style="display: none">
                        <label class="form-label">Дата</label>
                        <input name="date" class="form-control" placeholder="ММ.ГГГГ">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Создать</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Create planned expense -->
<div class="modal fade" id="createActualExpenseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="ajaxForm" action="/actual-expense" method="POST">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Создание актуального расхода</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Сумма</label>
                        <input name="amount" class="form-control" placeholder="0.0">
                        <input type="hidden" name="currency" value="RUB">
                        <input type="hidden" name="categoryId">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input name="title" class="form-control" placeholder="Молоко">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Дата</label>
                        <input name="date" class="form-control" placeholder="ДД.ММ.ГГГГ">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Создать</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Delete actual expense -->
<div class="modal fade" id="deleteActualExpenseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="ajaxForm" data-action-template="/actual-expense/{:id}" action="" method="DELETE">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Вы уверены, что хотите удалить фактический расход?</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="ajaxForm" action="/auth/login" method="POST">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Авторизация</h1>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Логин</label>
                        <input name="login" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Пароль</label>
                        <input type="password" name="password" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Войти</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script type="text/javascript">
    window.apiUrl = 'http://localhost:8080/v1';
    window.isAjaxInProcess = false;

    window.onload = function () {
        requestReport();
    }

    $(document).on('submit', 'form.ajaxForm', function (e) {
        e.preventDefault();
        let form = this;
        submitForm(form);
        $(window).resize();
    });


    function submitForm(form) {
        clearFormErrors(form);
        if (window.isAjaxInProcess) {
            return;
        }
        window.isAjaxInProcess = true;
        let action = window.apiUrl + $(form).attr('action');
        let method = $(form).attr('method');
        let data = new FormData(form);
        let object = {};
        data.forEach(function(value, key){
            object[key] = value;
        });
        let json = JSON.stringify(object);
        $.ajax({
            type: method,
            dataType: "JSON",
            url: action,
            data: json,
            processData: false,
            contentType: 'application/json',
            headers: {
                'Accept': 'application/json',
                'Access-Token': getAccessToken()
            },
            success: function (response) {
                window.isAjaxInProcess = false;
                if (response.response.accessToken) {
                    setAccessToken(response.response.accessToken);
                }
                requestReport();
            },
            error: function (response) {
                window.isAjaxInProcess = false;
                let json = JSON.parse(response.responseText);
                if (json.status === 'validation-error') {
                    processFormErrors(form, json.errors);
                }
                if (response.status === 403) {
                    initLogin();
                }
            }
        });
    }

    function setAccessToken(accessToken) {
        localStorage.setItem('accessToken', accessToken);
    }

    function getAccessToken() {
        return localStorage.getItem('accessToken');
    }

    function clearFormErrors(form) {
        $(form).find('input, select').removeClass('border-error');
        $(form).find('.text-danger').remove();
    }

    function processFormErrors(form, errors) {
        errors.forEach(function (element) {
            $(form).find('*[name="' + element.field + '"]').addClass('border-error');
            $(form).find('*[name="' + element.field + '"]').after('<small class="text-danger">' + element.error + '</small>');
        })
    }

    function requestReport() {
        if (window.isAjaxInProcess) {
            return
        }
        window.isAjaxInProcess = true;
        $.ajax({
            url: window.apiUrl + "/report?from=12.2022&to=03.2023",
            headers: {
                "Access-Token": getAccessToken()
            },
            success: function (result) {
                window.isAjaxInProcess = false;
                initReport(result.response);
            },
            error: function(result) {
                window.isAjaxInProcess = false;
                if (result.status === 403) {
                    initLogin();
                }
            }
        });
    }

    function initLogin() {
        let root = $('#root');
        root.html('');
        $('#loginModal').modal({backdrop: 'static', keyboard: false}).modal('show');
    }

    function initReport(data) {
        let root = $('#root');
        let html = `
				<div class="container-fluid">
					<div class="row">
						<div class="col">
							<h1>Финансы</h1>
						</div>
						<div class="col">
						    <form class="ajaxForm" action="/auth/logout" method="POST">
                                <button type="submit" class="btn btn-danger logoutButton">Выйти</button>
                            </form>
						</div>
					</div>
				<div class="row">`;
        html += '<div class="col">Месяц</div>';
        data.periods.forEach(function (element) {
            html += `<div class="col">` + element + `</div>`;
        });
        html += '</div>';

        html += '<hr>';

        html += `
				<div class="row">
					<div class="col text-center">
						Доход/Расход/Остаток
					</div>
				</div>
		 		<hr>
	 		`;

        html += `
				<div class="row">
					<div class="col">
						Доходы
					</div>
			`;

        data.incomes.periods.forEach(function (element) {
            var detalizationHtml = '';
            element.entries.forEach(function (entry) {
                detalizationHtml += `
						<span data-id="` + entry.id + `" class="incomeEntry">
							` + entry.money.amount + ` ` + entry.money.currency + ` ` + entry.title + ` ` + entry.earnedAt + `
							<button data-id="` + entry.id + `" type="button" class="btn btn-danger btn-xs deleteIncome" data-toggle="tooltip" data-placement="top" title="Удалить доход">-</button>
						</span><br>`;
            });
            html += `
					<div class="col">`
                + element.total.amount + ` ` + element.total.currency + `
						<button data-date="01.` + element.date + `" type="button" class="btn btn-success btn-xs createIncome" data-toggle="tooltip" data-placement="top" title="Создать доход">+</button>
				 		<br>
				 		<button type="button" class="btn btn-primary btn-xs showDetalization">
				 			Детализация
			 			</button>
			 			<div class="detaliaztion">
			 				` + detalizationHtml + `
		 				</div>
	 				</div>
 				`;
        });
        html += `</div>`;

        html += `<hr>`;

        html += `
				<div class="row">
					<div class="col">Расходы</div>`;
        data.totalExpenses.periods.forEach(function (element) {
            html += `
					<div class="col">
						Факт: ` + element.actual.amount + ` ` + element.actual.currency + `<br>
						План: ` + element.planned.amount + ` ` + element.planned.currency + `<br>
						Расход: ` + element.limitPercent + `%
					</div>
				`;
        });
        html += `</div>`;

        html += `<hr>`;

        html += `
				<div class="row">
					<div class="col">
						Остаток
					</div>
				`;
        data.remains.periods.forEach(function (element) {
            html += `
					<div class="col">
						Факт: ` + element.totalActual.amount + ` ` + element.totalActual.currency + `<br>
						План: ` + element.totalPlanned.amount + ` ` + element.totalPlanned.currency + `<br>
						Расход: ` + element.limitPercent + `%
					</div>
				`;
        });
        html += `</div>`;

        html += `<hr>`;

        html += `
				<div class="row">
					<div class="col text-center">
						Расходы по категориям
					</div>
				</div>
		 		<hr>
	 		`;

        data.expenses.categories.forEach(function (element) {
            html += `
					<div class="row">
						<div class="col">
							` + element.title + `
							<button data-id="` + element.id + `" type="button" class="btn btn-success btn-xs createDefaultPlannedExpense" data-toggle="tooltip" data-placement="top" title="Создать регулярный планируемый расход">+</button>
							<button data-id="` + element.id + `" data-title="` + element.title + `" data-type="` + element.type + `" type="button" class="btn btn-warning btn-xs updateCategory" data-toggle="tooltip" data-placement="top" title="Изменить категорию">/</button>
							<button data-id="` + element.id + `" type="button" class="btn btn-danger btn-xs deleteCategory" data-toggle="tooltip" data-placement="top" title="Удалить категорию">-</button>
						</div>
					`;
            element.periods.forEach(function (period) {
                var detalizationHtml = '';
                period.actualExpenses.forEach(function (entry) {
                    detalizationHtml += `
							<span class="expenseEntry">
								` + entry.money.amount + ` ` + entry.money.currency + ` ` + entry.title + ` ` + entry.spentAt + `
								<button data-id="` + entry.id + `" type="button" class="btn btn-danger btn-xs deleteActualExpense" data-toggle="tooltip" data-placement="top" title="Удалить фактический расход">-</button>
							</span>`;
                })
                html += `
						<div class="col">
							Факт: ` + period.totalActual.amount + ` ` + period.totalActual.currency + `
							<button data-date="01.` + period.date + `" data-category-id="` + element.id + `" type="button" class="btn btn-success btn-xs createActualExpense" data-toggle="tooltip" data-placement="top" title="Указать фактический расход">+</button>
							<br>
							План: ` + period.totalPlanned.amount + ` ` + period.totalPlanned.currency + `
							<button data-date="` + period.date + `" data-category-id="` + element.id + `" type="button" class="btn btn-success btn-xs createPlannedExpense" data-toggle="tooltip" data-placement="top" title="Указать план на месяц">+</button>
							<br> 
							Расход: ` + period.limitPercent + `% <br>
							<button type="button" class="btn btn-primary btn-xs showDetalization">Детализация</button>
							<div class="detaliaztion">` + detalizationHtml + `</div>
						</div>
					`;
            });
            html += '</div>';

            html += '<hr>';

        });

        html += `
				<div class="row">
					<div class="col">
						<button type="button" class="btn btn-primary btn-xs" data-bs-toggle="modal" data-bs-target="#createExpenseCategoryModal">
							Создать категорию
						</button>
					</div>
				</div>
		 		<hr>
	 		`;

        html += `</div>`;

        root.html(html);

        initTriggers();
        hideModals();
    }

    function initTriggers() {
        $('[data-toggle="tooltip"]').tooltip();

        $(document).on('click', '.createIncome', function () {
            let date = String($(this).data('date'));
            let modal = $('#createIncomeModal');
            modal.find('*[name="date"]').val(date);
            modal.modal('show');
        });

        $(document).on('click', '.deleteIncome', function () {
            let id = $(this).data('id');
            let modal = $('#deleteIncomeModal');
            modal.find('.ajaxForm').attr('action', modal.find('.ajaxForm').data('action-template').replace('{:id}', id));
            modal.modal('show');
        });

        $(document).on('click', '.deleteCategory', function () {
            let id = $(this).data('id');
            let modal = $('#deleteExpenseCategoryModal');
            modal.find('.ajaxForm').attr('action', modal.find('.ajaxForm').data('action-template').replace('{:id}', id));
            modal.modal('show');
        });

        $(document).on('click', '.updateCategory', function () {
            let id = $(this).data('id');
            let title = $(this).data('title');
            let type = $(this).data('type');
            let modal = $('#updateExpenseCategoryModal');
            modal.find('*[name="title"]').val(title);
            modal.find('*[name="type"]').val(type);
            modal.find('.ajaxForm').attr('action', modal.find('.ajaxForm').data('action-template').replace('{:id}', id));
            modal.modal('show');
        });

        $(document).on('click', '.createDefaultPlannedExpense', function(){
            let categoryId = $(this).data('id');
            let modal = $('#createPlannedExpense');
            modal.find('.date-input').hide();
            modal.find('*[name="categoryId"]').val(categoryId);
            modal.find('*[name="date"]').val('');
            modal.modal('show');
        })

        $(document).on('click', '.createPlannedExpense', function(){
            let categoryId = $(this).data('category-id');
            let date = String($(this).data('date'));
            let modal = $('#createPlannedExpense');
            modal.find('.date-input').show();
            modal.find('*[name="categoryId"]').val(categoryId);
            modal.find('*[name="date"]').val(date);
            modal.modal('show');
        })

        $(document).on('click', '.createActualExpense', function(){
            let categoryId = $(this).data('category-id');
            let date = String($(this).data('date'));
            let modal = $('#createActualExpenseModal');
            modal.find('.date-input').show();
            modal.find('*[name="categoryId"]').val(categoryId);
            modal.find('*[name="date"]').val(date);
            modal.modal('show');
        })

        $(document).on('click', '.deleteActualExpense', function(){
            let id = $(this).data('id');
            let modal = $('#deleteActualExpenseModal');
            modal.find('.ajaxForm').attr('action', modal.find('.ajaxForm').data('action-template').replace('{:id}', id));
            modal.modal('show');
        })
    }

    function hideModals() {
        $('.modal').modal('hide');
    }
</script>
<style>
    .col {
        position: relative;
    }

    .detaliaztion {
        display: none;
    }

    .showDetalization:hover + .detaliaztion, .detaliaztion:hover {
        display: block;
    }

    .detaliaztion {
        position: absolute;
        left: 12px;
        top: 100%;
        background: #fff;
        border-radius: 5px;
        border: 1px solid #eae9e9;
        padding: 15px 10px;
        width: max-content;
        z-index: 1;
    }

    .btn-group-xs > .btn, .btn-xs {
        --bs-btn-padding-y: 0.15rem;
        --bs-btn-padding-x: 0.35rem;
        --bs-btn-font-size: 0.65rem;
        --bs-btn-border-radius: 0.25rem;
        margin-top: -4px !important;
    }

    .border-error {
        border-color: red;
    }
    .logoutButton {
        float: right;
    }
</style>
</body>
</html>